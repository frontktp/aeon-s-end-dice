<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ì´ì–¸ì¦ˆ ì—”ë“œ í—¬í¼ (ë„¤ë©”ì‹œìŠ¤ 7ì¢…)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-zoom-in { animation: zoomIn 0.3s ease-out forwards; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans select-none h-screen flex overflow-hidden">

    <!-- í”Œë¡œíŒ… í—¤ë” ë²„íŠ¼ë“¤ (ì‚¬ì´ë“œë°”ê°€ ë‹«í˜”ì„ ë•Œ ë³´ì„) -->
    <div id="btn-open-left" class="absolute top-4 left-4 z-20 lg:hidden transition-opacity duration-300">
        <button onclick="openLeftSidebar()" class="p-2 bg-slate-800 rounded-lg shadow-lg border border-slate-700 text-slate-300 hover:text-white">
            <i data-lucide="book-open" class="w-6 h-6"></i>
        </button>
    </div>
    <div id="btn-open-right" class="absolute top-4 right-4 z-20 lg:hidden transition-opacity duration-300">
        <button onclick="openRightSidebar()" class="p-2 bg-slate-800 rounded-lg shadow-lg border border-slate-700 text-rose-400 hover:text-rose-200">
            <i data-lucide="skull" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- 1. ì¢Œì¸¡ ì‚¬ì´ë“œë°” (ìºë¦­í„°) -->
    <aside id="sidebar-left" class="fixed inset-y-0 left-0 z-30 w-80 bg-slate-800/95 backdrop-blur-md border-r border-slate-700 transform -translate-x-full lg:translate-x-0 lg:relative transition-transform duration-300 flex flex-col shadow-2xl lg:shadow-none">
        <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
            <h2 class="text-lg font-bold text-amber-500 flex items-center gap-2">
                <i data-lucide="users" class="w-5 h-5"></i> ê· ì—´ ë§ˆë²•ì‚¬
            </h2>
            <button onclick="closeLeftSidebar()" class="text-slate-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <div class="p-4 pb-2">
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-500"></i>
                <input type="text" id="char-search" placeholder="ì´ë¦„ ê²€ìƒ‰..." onkeyup="filterCharacters()" 
                    class="w-full bg-slate-900 border border-slate-700 rounded-lg py-2 pl-9 pr-4 text-sm text-slate-200 focus:outline-none focus:border-amber-500 placeholder-slate-600">
            </div>
            <div class="mt-2 text-xs text-slate-500 text-center">
                [P1], [P2] ë²„íŠ¼ìœ¼ë¡œ í”Œë ˆì´ì–´ë¥¼ ì§€ì •í•˜ì„¸ìš”.
            </div>
        </div>

        <div id="character-list" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
            <!-- ìºë¦­í„° ë¦¬ìŠ¤íŠ¸ ìƒì„±ë¨ -->
        </div>
    </aside>

    <!-- 2. ë©”ì¸ ê²Œì„ ì˜ì—­ -->
    <main class="flex-1 flex flex-col items-center justify-center p-4 relative w-full overflow-y-auto min-w-0 transition-all duration-300">
        <div class="w-full max-w-xl flex justify-between items-center mb-6 px-2 mt-12 lg:mt-0">
            <div id="round-display" class="text-xl font-bold bg-slate-800 px-4 py-2 rounded-lg shadow-lg border border-slate-700">
                Round 1
            </div>
            <button onclick="resetGame()" class="p-2 text-slate-400 hover:text-white transition-colors" title="ê²Œì„ ë¦¬ì…‹">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="relative w-full max-w-xl h-[560px] mb-6 group perspective-1000">
            <!-- ë’·ë©´ -->
            <div id="card-back" class="absolute inset-0 w-full h-full bg-slate-800 rounded-3xl shadow-2xl border-4 border-slate-700 flex flex-col items-center justify-center cursor-pointer hover:scale-[1.02] transition-transform duration-200" onclick="handleMainAction()">
                <div class="text-6xl mb-4 opacity-50">ğŸƒ</div>
                <p class="text-xl font-bold text-slate-400">í„°ì¹˜í•˜ì—¬ ì¹´ë“œ ë½‘ê¸°</p>
                <p id="deck-count" class="text-sm text-slate-500 mt-2">6ì¥ ë‚¨ìŒ</p>
            </div>
            <!-- ì…”í”Œ ì¤‘ -->
            <div id="shuffling-view" class="hidden absolute inset-0 w-full h-full bg-slate-800 rounded-3xl shadow-2xl border-4 border-slate-700 flex flex-col items-center justify-center animate-pulse">
                <i data-lucide="shuffle" class="w-16 h-16 animate-spin mb-4 text-purple-400"></i>
                <p class="text-xl font-bold text-purple-400">ì…”í”Œ ì¤‘...</p>
            </div>
            <!-- ì•ë©´ -->
            <div id="card-front" onclick="handleMainAction()" class="hidden absolute inset-0 w-full h-full rounded-3xl shadow-[0_0_30px_rgba(0,0,0,0.5)] border-4 border-white/10 flex flex-col items-center justify-center transition-all duration-300 animate-zoom-in cursor-pointer hover:scale-[1.02] group-card">
                <button onclick="event.stopPropagation(); openReturnModal(-1);" class="absolute top-4 right-4 p-2 bg-black/30 hover:bg-black/50 rounded-full text-white/70 hover:text-white transition-colors z-10" title="ì´ ì¹´ë“œë¥¼ ë±ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°">
                    <i data-lucide="undo-2" class="w-6 h-6"></i>
                </button>
                <div class="w-full flex-1 flex flex-col items-center p-4 text-center pointer-events-none overflow-hidden">
                    <!-- ìƒë‹¨ ì˜ì—­: ì•„ì´ì½˜ + ì´ë¦„ (ê³ ì • ë†’ì´) -->
                    <div class="flex flex-col items-center justify-center min-h-[160px]">
                        <div id="card-icon-container" class="flex-shrink-0 flex items-center justify-center mb-3 backdrop-blur-sm shadow-inner text-white"></div>
                        <h2 id="card-name" class="text-3xl font-extrabold drop-shadow-md mb-1"></h2>
                        <p id="card-sub-name" class="text-lg font-bold text-white/80 mb-1 hidden"></p>
                        <p id="card-turn-label" class="text-white/60 font-medium text-sm">Turn Order</p>
                    </div>
                    <!-- í•˜ë‹¨ ì˜ì—­: ìŠ¤í‚¬ ì •ë³´ (ë‚˜ë¨¸ì§€ ê³µê°„) -->
                    <div id="card-skill-container" class="hidden w-full flex-1 px-2 mt-2 overflow-hidden">
                        <div class="bg-black/30 backdrop-blur-sm rounded-xl p-3 border border-white/10 h-full flex flex-col">
                            <p id="card-skill-condition" class="text-amber-400 font-bold text-sm mb-2 py-1 px-2 bg-amber-500/20 rounded-lg inline-block flex-shrink-0"></p>
                            <p id="card-skill-name" class="text-white font-bold text-sm mb-1 flex-shrink-0"></p>
                            <p id="card-skill-desc" class="text-white/70 text-xs leading-relaxed flex-1 overflow-y-auto custom-scrollbar"></p>
                        </div>
                    </div>
                </div>
                <div class="w-full py-3 bg-black/20 backdrop-blur-md rounded-b-2xl flex justify-center items-center gap-2 pointer-events-none">
                    <span id="card-footer-info" class="text-sm font-medium text-white/50"></span>
                </div>
            </div>
        </div>

        <button id="action-btn" onclick="handleMainAction()" class="w-full max-w-xl py-4 rounded-xl text-xl font-bold shadow-lg transition-all transform active:scale-95 mb-8 bg-slate-700 hover:bg-slate-600 text-white shadow-slate-900/50 flex items-center justify-center gap-2">
            ë‹¤ìŒ í„´ ì¹´ë“œ ë½‘ê¸°
        </button>

        <div class="w-full max-w-xl bg-slate-800/50 rounded-xl p-4 border border-slate-700 backdrop-blur-sm">
            <div class="flex items-center justify-between mb-3 text-slate-400">
                <div class="flex items-center gap-2">
                    <i data-lucide="history" class="w-4 h-4"></i>
                    <span class="text-sm font-semibold">ì´ë²ˆ ë¼ìš´ë“œ ê¸°ë¡</span>
                </div>
                <span class="text-xs opacity-60">í´ë¦­í•˜ì—¬ ë± ë°˜í™˜</span>
            </div>
            <div id="history-container" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide justify-center"></div>
        </div>
    </main>

    <!-- 3. ìš°ì¸¡ ì‚¬ì´ë“œë°” (ë„¤ë©”ì‹œìŠ¤) -->
    <aside id="sidebar-right" class="fixed inset-y-0 right-0 z-30 w-80 bg-slate-800/95 backdrop-blur-md border-l border-slate-700 transform translate-x-full lg:translate-x-0 lg:relative transition-transform duration-300 flex flex-col shadow-2xl lg:shadow-none">
        <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
            <h2 class="text-lg font-bold text-rose-500 flex items-center gap-2">
                <i data-lucide="skull" class="w-5 h-5"></i> ë„¤ë©”ì‹œìŠ¤ ì„ íƒ
            </h2>
            <button onclick="closeRightSidebar()" class="text-slate-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <div class="p-4 text-xs text-slate-500 text-center">
            ì´ë²ˆ ê²Œì„ì˜ ë„¤ë©”ì‹œìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.
        </div>

        <div id="nemesis-list" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
            <!-- ë„¤ë©”ì‹œìŠ¤ ë¦¬ìŠ¤íŠ¸ ìƒì„±ë¨ -->
        </div>
    </aside>

    <div id="sidebar-overlay" onclick="closeSidebars()" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>


    <!-- ë± ë°˜í™˜ ëª¨ë‹¬ -->
    <div id="return-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm animate-fade-in p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <div class="flex items-center gap-3 mb-4 text-amber-400">
                <i data-lucide="rotate-ccw" class="w-6 h-6"></i>
                <h3 class="text-xl font-bold text-white">ì¹´ë“œ ë°˜í™˜</h3>
            </div>
            <p class="text-slate-300 mb-6 leading-relaxed">
                <span id="modal-card-name" class="font-bold text-white"></span> ì¹´ë“œë¥¼<br/>
                ë±ìœ¼ë¡œ ë˜ëŒë¦¬ê³  ì„ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?
            </p>
            <div class="flex gap-3">
                <button onclick="closeReturnModal()" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-xl font-semibold">ì·¨ì†Œ</button>
                <button onclick="confirmReturn()" class="flex-1 py-3 bg-amber-600 hover:bg-amber-500 text-white rounded-xl font-bold shadow-lg">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. ë°ì´í„° ---
        const CHARACTERS = [
            { name: "ì•„ë¸í•˜ì„", charge: 5, skill: "ì—í…Œë¥´ ë°©ë²½", desc: "ë„¤ë©”ì‹œìŠ¤ ë½‘ê¸° ë‹¨ê³„ ë™ì•ˆ í™œì„±í™”: ë„¤ë©”ì‹œìŠ¤ ê³µê²© ì¹´ë“œ ë˜ëŠ” ìœ„ë ¥ ì¹´ë“œê°€ ë½‘í˜”ì„ ë•Œ, ë‹¹ì‹ ì€ ì›í•œë‹¤ë©´ ì¹´ë“œ íš¨ê³¼ë¥¼ ìˆ˜í–‰í•˜ê¸° ì „ì— í•´ë‹¹ ì¹´ë“œë¥¼ ë²„ë¦½ë‹ˆë‹¤. í•´ë‹¹ ì¹´ë“œëŠ” ì•„ë¬´ëŸ° íš¨ê³¼ë„ ì—†ì´ ë²„ë ¤ì§‘ë‹ˆë‹¤. (ë„¤ë©”ì‹œìŠ¤ëŠ” ë²„ë ¤ì§„ ì¹´ë“œë¥¼ ëŒ€ì²´í•  ë‹¤ë¥¸ ì¹´ë“œë¥¼ ë½‘ì§€ ì•ŠìŠµë‹ˆë‹¤.)" },
            { name: "ë¸Œë¼ë§ˆ", charge: 6, skill: "ê¸´ê¸‰ í¡ì¸", desc: "ë‹¹ì‹ ì˜ í–‰ë™ ë‹¨ê³„ ë™ì•ˆ í™œì„±í™”: ì•„ë¬´ í”Œë ˆì´ì–´ 1ëª…ì€ ìƒëª…ë ¥ì„ 4 ì–»ìŠµë‹ˆë‹¤." },
            { name: "ë§ë¼ìŠ¤íƒ€ë¥´", charge: 6, skill: "ì—í…Œë¥´ì˜ ì„ ë¬¼", desc: "ë‹¹ì‹ ì˜ í–‰ë™ ë‹¨ê³„ ë™ì•ˆ í™œì„±í™”: ì•„ë¬´ ê³µê¸‰ ë”ë¯¸ 1ê³³ì—ì„œ ì£¼ë¬¸ 1ì¥ì„ ì–»ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì€ ì›í•œë‹¤ë©´ í•´ë‹¹ ì£¼ë¬¸ì„ ì•„ë¬´ í”Œë ˆì´ì–´ 1ëª…ì˜ ê°œë°©ëœ ê· ì—´ì— ì¤€ë¹„í•©ë‹ˆë‹¤." },
            { name: "í˜ë“œë½ì‚¬", charge: 5, skill: "ì ìŸì´ ë£¬", desc: "ì°¨ë¡€ ìˆœì„œ ì¹´ë“œë¥¼ ë½‘ì€ ì§í›„ í™œì„±í™”: í•´ë‹¹ ì°¨ë¡€ ë™ì•ˆ í”Œë ˆì´ì–´ë“¤ ë° ê·¸ë ˆì´ë¸Œí™€ë“œê°€ ë°›ì„ í”¼í•´ë¥¼ ëª¨ë‘ ë°©ì§€í•©ë‹ˆë‹¤." },
            { name: "ì¦ˆí•˜ë‚˜", charge: 5, skill: "ì„±ì†Œì˜ ìƒí˜•ë¬¸ì", desc: "ë‹¹ì‹ ì˜ í–‰ë™ ë‹¨ê³„ ë™ì•ˆ í™œì„±í™”: ê·¸ë ˆì´ë¸Œí™€ë“œëŠ” ìƒëª…ë ¥ì„ 7 ì–»ìŠµë‹ˆë‹¤." },
            { name: "ë¼ì‰¬", charge: 5, skill: "ë¹ ë¥¸ ë‘ë‡Œ íšŒì „", desc: "ì•„ë¬´ í”Œë ˆì´ì–´ 1ëª…ì˜ í–‰ë™ ë‹¨ê³„ ë™ì•ˆ í™œì„±í™”: ì•„ë¬´ í”Œë ˆì´ì–´ 1ëª…ì˜ ì°¨ë¡€ ìˆœì„œ ì¹´ë“œ 1ì¥ì„ ì°¨ë¡€ ìˆœì„œ ë±ì— ë„£ê³  ì„ìŠµë‹ˆë‹¤. í•´ë‹¹ í”Œë ˆì´ì–´ëŠ” í”¼í•´ë¥¼ 1 ë°›ìŠµë‹ˆë‹¤. (ê³µìš© ì°¨ë¡€ ìˆœì„œ ì¹´ë“œëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)" },
            { name: "ë ˆì—ë² ", charge: 4, skill: "ì œì••í•˜ëŠ” ì¹¼ë‚ ", desc: "ë‹¹ì‹ ì˜ í–‰ë™ ë‹¨ê³„ ë™ì•ˆ í™œì„±í™”: í•˜ìˆ˜ì¸ í•˜ë‚˜ì—ê²Œ í”¼í•´ë¥¼ 5 ì…í™ë‹ˆë‹¤. ë‹¤ë¥¸ í•˜ìˆ˜ì¸ í•˜ë‚˜ì—ê²Œ í”¼í•´ë¥¼ 3 ì…í™ë‹ˆë‹¤." },
            { name: "ë‹˜", charge: 5, skill: "ì¢…ë‹¨ì˜ ì¥ë§‰", desc: "ë‹¹ì‹ ì˜ í–‰ë™ ë‹¨ê³„ ë™ì•ˆ í™œì„±í™”: ë„¤ë©”ì‹œìŠ¤ ë± ë§¨ ìœ„ ì¹´ë“œë¥¼ ë²„ë¦½ë‹ˆë‹¤. ë²„ë¦° ì¹´ë“œê°€ ê³µê²© ì¹´ë“œì¼ ê²½ìš°, 1ì¥ì„ ì¶”ê°€ë¡œ ë²„ë¦½ë‹ˆë‹¤." },
            { name: "í¬ì‚­ì†ŒìŠ¤", charge: 5, skill: "í˜•ì´ìƒí•™ì  ì—°ê²°", desc: "ì•„ë¬´ í”Œë ˆì´ì–´ 1ëª…ì˜ í–‰ë™ ë‹¨ê³„ ë™ì•ˆ í™œì„±í™”: ë™ë£Œ ì „ì²´ê°€ í†µí‹€ì–´ ì¶©ì „ì„ 4ê°œë¥¼ ì–»ìŠµë‹ˆë‹¤. ì°¨ë¡€ ìˆœì„œ ë±ì„ ì „ë¶€ ê³µê°œí•˜ê³ , ê³µê°œëœ ì¹´ë“œë“¤ì„ ì›í•˜ëŠ” ìˆœì„œëŒ€ë¡œ ë±ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤." },
            { name: "ë¯¸ìŠ¤íŠ¸", charge: 5, skill: "ì„±ìŠ¤ëŸ¬ìš´ ì ì¹˜ê¸°", desc: "ë‹¹ì‹ ì˜ í–‰ë™ ë‹¨ê³„ ë™ì•ˆ í™œì„±í™”: ì•„ë¬´ ë™ë£Œ 1ëª…ì€ ì¹´ë“œ 4ì¥ì„ ë½‘ìŠµë‹ˆë‹¤." },
            { name: "ì¹´ë””ë¥´", charge: 5, skill: "ì´ê³„ì˜ ì°¨ì›ë¬¸", desc: "ì•„ë¬´ í”Œë ˆì´ì–´ 1ëª…ì˜ í–‰ë™ ë‹¨ê³„ ë™ì•ˆ í™œì„±í™”: í•´ë‹¹ í”Œë ˆì´ì–´ëŠ” ì›í•œë‹¤ë©´ ìì‹ ì˜ ë²„ë¦¼ ë”ë¯¸ì— ìˆëŠ” ì£¼ë¬¸ì„ 3ì¥ê¹Œì§€ ìì‹ ì˜ ì†ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤. í•´ë‹¹ í”Œë ˆì´ì–´ëŠ” ì›í•œë‹¤ë©´ ì´ë²ˆ ì°¨ë¡€ì— ìì‹ ì˜ ê°œë°©ëœ ê· ì—´ë§ˆë‹¤ ì£¼ë¬¸ì„ 2ì¥ê¹Œì§€ ì¤€ë¹„í•©ë‹ˆë‹¤." },
            { name: "ì§€ì•ˆ", charge: 4, skill: "ê²€ì€ ê±°ìš¸", desc: "ë‹¹ì‹ ì˜ í–‰ë™ ë‹¨ê³„ ë™ì•ˆ í™œì„±í™”: ì•„ë¬´ í”Œë ˆì´ì–´ 1ëª…ì˜ ì¤€ë¹„ëœ ì£¼ë¬¸ 1ì¥ì„ ë²„ë¦¬ì§€ ì•Šê³  ë°œë™í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ ê·¸ ì¤€ë¹„ëœ ì£¼ë¬¸ì„ ë‹¤ì‹œ ë°œë™í•©ë‹ˆë‹¤. (ë‘ ë²ˆì§¸ ë°œë™ í›„ì—ëŠ” ë²„ë¦½ë‹ˆë‹¤.)" }
        ];

        // ì´ë¯¸ì§€ íŒŒì¼ëª…ê³¼ ì¼ì¹˜í•˜ë„ë¡ í•œê¸€ ì´ë¦„ ì„¤ì • (ê´„í˜¸ ì•ˆ ì˜ë¬¸ì€ UI í‘œì‹œìš©)
        const NEMESES = [
            { name: "ë¶„ë…¸ì˜ ì „ë ¹", enName: "Rageborne", imgFile: "ë¶„ë…¸ì˜ì •ë ¹" },
            { name: "ê°‘ê° ì—¬ì™•", enName: "Carapace Queen", imgFile: "ê°‘ê°ì—¬ì™•" },
            { name: "í­ì‹ ì™•ì", enName: "Prince of Gluttony", imgFile: "í­ì‹ì™•ì" },
            { name: "ë’¤í‹€ë¦° ê°€ë©´", enName: "Crooked Mask", imgFile: "ë’¤í‹€ë¦°ê°€ë©´" },
            { name: "í™©íì˜ êµ°ì£¼", enName: "Decimus", imgFile: "í™©íì˜êµ°ì£¼" },
            { name: "ë¶€ì¡± ë§ˆë…€", enName: "Horde-Crone", imgFile: "ë¶€ì¡±ë§ˆë…€" },
            { name: "ë¶ˆê°€í•´í•œ ì¡´ì¬", enName: "The Wayward One", imgFile: "ë¶ˆê°€í•´í•œì¡´ì¬" }
        ];

        // ìƒíƒœ
        let assignedP1 = null; 
        let assignedP2 = null;
        let assignedNemesis = null;

        // --- 2. ë Œë”ë§ ë¡œì§ (ì‚¬ì´ë“œë°”) ---
        
        function formatDescription(desc) {
            const regex = /^(.*?)(í™œì„±í™”\s*:)(.*)$/s;
            const match = desc.match(regex);
            if (match) {
                return `<span class="block text-amber-400 font-bold text-sm mb-1 mt-2">${match[1]}${match[2]}</span><span class="text-slate-300">${match[3]}</span>`;
            }
            return desc;
        }

        function toggleAssign(charName, player) {
            const char = CHARACTERS.find(c => c.name === charName);
            if (!char) return;

            if (player === 'P1') {
                assignedP1 = (assignedP1 === char) ? null : char;
                if (assignedP2 === char) assignedP2 = null;
            } else if (player === 'P2') {
                assignedP2 = (assignedP2 === char) ? null : char;
                if (assignedP1 === char) assignedP1 = null;
            }
            renderLeftSidebar(document.getElementById('char-search').value);
            render(); 
        }

        function toggleNemesisAssign(nemesisName) {
            const nem = NEMESES.find(n => n.name === nemesisName);
            if (!nem) return;

            if (assignedNemesis === nem) {
                assignedNemesis = null;
            } else {
                assignedNemesis = nem;
            }
            renderRightSidebar();
            render();
        }

        function renderLeftSidebar(filterText = "") {
            const list = document.getElementById('character-list');
            list.innerHTML = "";
            const filtered = CHARACTERS.filter(c => c.name.includes(filterText));

            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-slate-500 text-center py-4 text-sm">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            filtered.forEach(char => {
                const isP1 = assignedP1 === char;
                const isP2 = assignedP2 === char;

                const item = document.createElement('div');
                let borderClass = "border-slate-700";
                if (isP1) borderClass = "border-blue-500 ring-1 ring-blue-500 bg-slate-800";
                else if (isP2) borderClass = "border-emerald-500 ring-1 ring-emerald-500 bg-slate-800";
                else borderClass = "hover:border-slate-500 bg-slate-900";

                item.className = `group border rounded-lg p-3 transition-all shadow-sm relative overflow-hidden ${borderClass}`;
                
                const formattedDesc = formatDescription(char.desc);
                const imgPath = `char/${char.name}.png`;

                item.innerHTML = `
                    <div class="flex items-start gap-4 mb-2">
                        <div class="w-14 h-14 rounded-full bg-slate-800 overflow-hidden flex-shrink-0 border border-slate-600 shadow-md">
                            <img src="${imgPath}" alt="${char.name}" class="w-full h-full object-cover" 
                                onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                            <div class="hidden w-full h-full flex items-center justify-center text-slate-500">
                                <i data-lucide="user" class="w-8 h-8 opacity-50"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <div class="flex flex-col">
                                    <span class="font-bold text-slate-200 text-lg flex items-center gap-2 truncate">
                                        ${char.name}
                                        ${isP1 ? '<span class="text-[10px] bg-blue-600 text-white px-1.5 py-0.5 rounded flex-shrink-0">P1</span>' : ''}
                                        ${isP2 ? '<span class="text-[10px] bg-emerald-600 text-white px-1.5 py-0.5 rounded flex-shrink-0">P2</span>' : ''}
                                    </span>
                                    <span class="text-sm font-semibold text-emerald-400 mt-0.5">${char.skill}</span>
                                </div>
                                <span class="text-xs font-bold px-2 py-1 rounded bg-amber-900/30 text-amber-400 border border-amber-900/50 whitespace-nowrap ml-2">
                                    ì¶©ì „ ${char.charge}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400 leading-relaxed keep-all border-t border-slate-700/50 pt-2">
                        ${formattedDesc}
                    </div>
                    <div class="flex gap-2 mt-3 pt-2 border-t border-slate-700/50">
                        <button onclick="toggleAssign('${char.name}', 'P1')" 
                            class="flex-1 py-1.5 text-xs font-bold rounded transition-colors ${isP1 ? 'bg-blue-600 text-white hover:bg-blue-500' : 'bg-slate-700 text-slate-300 hover:bg-slate-600 hover:text-white'}">
                            ${isP1 ? 'P1 ì„ íƒë¨' : 'P1 ì§€ì •'}
                        </button>
                        <button onclick="toggleAssign('${char.name}', 'P2')" 
                            class="flex-1 py-1.5 text-xs font-bold rounded transition-colors ${isP2 ? 'bg-emerald-600 text-white hover:bg-emerald-500' : 'bg-slate-700 text-slate-300 hover:bg-slate-600 hover:text-white'}">
                            ${isP2 ? 'P2 ì„ íƒë¨' : 'P2 ì§€ì •'}
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function renderRightSidebar() {
            const list = document.getElementById('nemesis-list');
            list.innerHTML = "";

            NEMESES.forEach(nem => {
                const isSelected = assignedNemesis === nem;
                const item = document.createElement('div');
                const borderClass = isSelected 
                    ? "border-rose-600 ring-1 ring-rose-600 bg-slate-800" 
                    : "border-slate-700 hover:border-slate-500 bg-slate-900";

                item.className = `group border rounded-lg p-3 transition-all shadow-sm cursor-pointer ${borderClass}`;
                item.onclick = () => toggleNemesisAssign(nem.name);
                const imgPath = `nemesis/${nem.imgFile}.png`;

                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-md bg-slate-800 overflow-hidden flex-shrink-0 border border-slate-600 shadow-md">
                            <img src="${imgPath}" alt="${nem.name}" class="w-full h-full object-cover" 
                                onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                            <div class="hidden w-full h-full flex items-center justify-center text-slate-500">
                                <i data-lucide="skull" class="w-8 h-8 opacity-50"></i>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-slate-200 text-sm group-hover:text-rose-400 transition-colors">${nem.name}</h3>
                            <p class="text-xs text-slate-500 mt-1">${nem.enName}</p>
                        </div>
                        ${isSelected ? '<div class="text-rose-500"><i data-lucide="check-circle-2" class="w-6 h-6"></i></div>' : ''}
                    </div>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function filterCharacters() {
            const text = document.getElementById('char-search').value;
            renderLeftSidebar(text);
        }

        // --- ì‚¬ì´ë“œë°” í† ê¸€ ë¡œì§ ---
        
        function openLeftSidebar() {
            const left = document.getElementById('sidebar-left');
            const btn = document.getElementById('btn-open-left');
            const overlay = document.getElementById('sidebar-overlay');
            
            left.classList.remove('-translate-x-full');
            left.classList.add('lg:translate-x-0', 'lg:relative');
            btn.classList.add('lg:hidden');

            if (window.innerWidth < 1024) {
                overlay.classList.remove('hidden');
            }
        }

        function closeLeftSidebar() {
            const left = document.getElementById('sidebar-left');
            const btn = document.getElementById('btn-open-left');
            const overlay = document.getElementById('sidebar-overlay');

            left.classList.add('-translate-x-full');
            left.classList.remove('lg:translate-x-0', 'lg:relative');
            btn.classList.remove('lg:hidden');
            
            overlay.classList.add('hidden');
        }

        function openRightSidebar() {
            const right = document.getElementById('sidebar-right');
            const btn = document.getElementById('btn-open-right');
            const overlay = document.getElementById('sidebar-overlay');

            right.classList.remove('translate-x-full');
            right.classList.add('lg:translate-x-0', 'lg:relative');
            btn.classList.add('lg:hidden');
            
            if (window.innerWidth < 1024) {
                overlay.classList.remove('hidden');
            }
        }

        function closeRightSidebar() {
            const right = document.getElementById('sidebar-right');
            const btn = document.getElementById('btn-open-right');
            const overlay = document.getElementById('sidebar-overlay');

            right.classList.add('translate-x-full');
            right.classList.remove('lg:translate-x-0', 'lg:relative');
            btn.classList.remove('lg:hidden');
            
            overlay.classList.add('hidden');
        }

        function closeSidebars() {
            if (window.innerWidth < 1024) {
                const left = document.getElementById('sidebar-left');
                const right = document.getElementById('sidebar-right');
                
                left.classList.add('-translate-x-full');
                right.classList.add('translate-x-full');
                document.getElementById('sidebar-overlay').classList.add('hidden');
            }
        }

        // --- 3. í„´ì˜¤ë” ê²Œì„ ë¡œì§ ---
        const CARD_TYPES = {
            'P1': { id: 'P1', name: 'í”Œë ˆì´ì–´ 1', colorClass: 'bg-blue-600', subColorClass: 'bg-blue-800', textColorClass: 'text-blue-100', icon: 'user' },
            'P2': { id: 'P2', name: 'í”Œë ˆì´ì–´ 2', colorClass: 'bg-emerald-600', subColorClass: 'bg-emerald-800', textColorClass: 'text-emerald-100', icon: 'user' },
            'N':  { id: 'N',  name: 'ë„¤ë©”ì‹œìŠ¤',   colorClass: 'bg-rose-900',  subColorClass: 'bg-rose-950',  textColorClass: 'text-rose-100',  icon: 'skull' },
        };

        let deck = [];
        let drawnCard = null;
        let roundHistory = [];
        let round = 1;
        let isShuffling = false;
        let targetReturnIndex = null; 

        function generateDeck() { return ['P1', 'P1', 'P2', 'P2', 'N', 'N']; }
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function initGame() {
            deck = shuffleArray(generateDeck());
            drawnCard = null;
            roundHistory = [];
            round = 1;
            render();
        }

        function startNewRound() {
            isShuffling = true;
            render();
            setTimeout(() => {
                deck = shuffleArray(generateDeck());
                drawnCard = null;
                roundHistory = [];
                if (round > 0) round++;
                isShuffling = false;
                render();
            }, 800);
        }

        function handleMainAction() {
            if (isShuffling) return;
            if (!document.getElementById('return-modal').classList.contains('hidden')) return;

            if (deck.length === 0 && drawnCard) {
                startNewRound();
                return;
            }

            if (deck.length > 0) {
                const cardId = deck.pop();
                drawnCard = CARD_TYPES[cardId];
                roundHistory.push(drawnCard);
                render();
            } else {
                startNewRound();
            }
        }

        function resetGame() {
            if (confirm('ê²Œì„ì„ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) initGame();
        }

        function openReturnModal(index) {
            if (index === -1) {
                if (roundHistory.length === 0) return;
                index = roundHistory.length - 1;
            }
            targetReturnIndex = index;
            document.getElementById('modal-card-name').textContent = roundHistory[index].name;
            document.getElementById('return-modal').classList.remove('hidden');
        }

        function closeReturnModal() {
            document.getElementById('return-modal').classList.add('hidden');
            targetReturnIndex = null;
        }

        function confirmReturn() {
            if (targetReturnIndex === null || targetReturnIndex < 0 || targetReturnIndex >= roundHistory.length) {
                closeReturnModal();
                return;
            }
            const removedCard = roundHistory.splice(targetReturnIndex, 1)[0];
            deck.push(removedCard.id);
            shuffleArray(deck);
            if (roundHistory.length > 0) drawnCard = roundHistory[roundHistory.length - 1];
            else drawnCard = null;
            closeReturnModal();
            render();
        }

        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('return-modal').classList.contains('hidden')) {
                if (e.key === 'Escape') closeReturnModal();
                return;
            }
            if ((e.code === 'Space' || e.key === ' ') && document.activeElement.tagName !== 'INPUT') {
                e.preventDefault(); 
                handleMainAction();
            }
        });

        function render() {
            // ë¼ìš´ë“œ/ë± ì •ë³´
            document.getElementById('round-display').textContent = `Round ${round}`;
            document.getElementById('deck-count').textContent = `${deck.length}ì¥ ë‚¨ìŒ`;

            // ë·° ì „í™˜
            const backView = document.getElementById('card-back');
            const shuffleView = document.getElementById('shuffling-view');
            const frontView = document.getElementById('card-front');
            const actionBtn = document.getElementById('action-btn');
            const subNameEl = document.getElementById('card-sub-name');
            const iconContainer = document.getElementById('card-icon-container');
            const skillContainer = document.getElementById('card-skill-container');
            const skillNameEl = document.getElementById('card-skill-name');
            const skillDescEl = document.getElementById('card-skill-desc');

            if (isShuffling) {
                backView.classList.add('hidden'); shuffleView.classList.remove('hidden'); frontView.classList.add('hidden');
                actionBtn.disabled = true; actionBtn.textContent = "ì…”í”Œ ì¤‘...";
            } else if (drawnCard) {
                backView.classList.add('hidden'); shuffleView.classList.add('hidden'); frontView.classList.remove('hidden');
                
                frontView.className = `absolute inset-0 w-full h-full rounded-3xl shadow-[0_0_30px_rgba(0,0,0,0.5)] border-4 border-white/10 flex flex-col items-center justify-center transition-all duration-300 animate-zoom-in cursor-pointer hover:scale-[1.02] ${drawnCard.subColorClass} group-card`;
                document.getElementById('card-name').className = `text-4xl font-extrabold drop-shadow-md mb-2 ${drawnCard.textColorClass}`;
                document.getElementById('card-name').textContent = drawnCard.name;
                
                // ìºë¦­í„° ë° ë„¤ë©”ì‹œìŠ¤ ì´ë¯¸ì§€ ì²˜ë¦¬
                let displayImg = null;
                let assignedChar = null;
                subNameEl.classList.add('hidden'); // ê¸°ë³¸ ìˆ¨ê¹€
                skillContainer.classList.add('hidden'); // ìŠ¤í‚¬ ê¸°ë³¸ ìˆ¨ê¹€

                if (drawnCard.id === 'P1' && assignedP1) {
                    assignedChar = assignedP1;
                    subNameEl.textContent = assignedP1.name;
                    subNameEl.classList.remove('hidden');
                    displayImg = `char/${assignedP1.name}.png`;
                } else if (drawnCard.id === 'P2' && assignedP2) {
                    assignedChar = assignedP2;
                    subNameEl.textContent = assignedP2.name;
                    subNameEl.classList.remove('hidden');
                    displayImg = `char/${assignedP2.name}.png`;
                } else if (drawnCard.id === 'N' && assignedNemesis) {
                    subNameEl.textContent = assignedNemesis.name;
                    subNameEl.classList.remove('hidden');
                    displayImg = `nemesis/${assignedNemesis.imgFile}.png`;
                }

                // í”Œë ˆì´ì–´ ì¹´ë“œì´ê³  ìºë¦­í„°ê°€ ì§€ì •ëœ ê²½ìš° ìŠ¤í‚¬ í‘œì‹œ
                if (assignedChar) {
                    const skillConditionEl = document.getElementById('card-skill-condition');
                    // í™œì„±í™” ì¡°ê±´ ì¶”ì¶œ (ì˜ˆ: "ë‹¹ì‹ ì˜ í–‰ë™ ë‹¨ê³„ ë™ì•ˆ í™œì„±í™”")
                    const conditionMatch = assignedChar.desc.match(/^(.*?í™œì„±í™”)\s*:/);
                    const effectMatch = assignedChar.desc.match(/í™œì„±í™”\s*:\s*(.*)$/s);

                    skillConditionEl.textContent = conditionMatch ? `â±ï¸ ${conditionMatch[1]}` : 'â±ï¸ í™œì„±í™”';
                    skillNameEl.textContent = `âœ¨ ${assignedChar.skill}`;
                    skillDescEl.textContent = effectMatch ? effectMatch[1].trim() : assignedChar.desc;
                    skillContainer.classList.remove('hidden');
                }

                // ê³ ì • í¬ê¸° ì•„ì´ì½˜ ì»¨í…Œì´ë„ˆ (í•­ìƒ ë™ì¼í•œ í¬ê¸°)
                const imgSize = "w-24 h-24";
                if (displayImg) {
                    iconContainer.className = `flex-shrink-0 ${imgSize} rounded-full bg-black/20 mb-3 backdrop-blur-sm shadow-inner text-white flex items-center justify-center overflow-hidden border-4 border-white/20`;
                    iconContainer.innerHTML = `
                        <img src="${displayImg}" class="w-full h-full object-cover"
                             onerror="this.style.display='none'; this.parentNode.innerHTML='<i data-lucide=\\'${drawnCard.icon}\\' class=\\'w-10 h-10\\'></i>'; this.parentNode.className='flex-shrink-0 ${imgSize} rounded-full bg-black/20 mb-3 backdrop-blur-sm shadow-inner text-white flex items-center justify-center';">
                    `;
                } else {
                    iconContainer.className = `flex-shrink-0 ${imgSize} rounded-full bg-black/20 mb-3 backdrop-blur-sm shadow-inner text-white flex items-center justify-center`;
                    iconContainer.innerHTML = `<i data-lucide="${drawnCard.icon}" class="w-12 h-12"></i>`;
                }

                document.getElementById('card-footer-info').textContent = deck.length === 0 ? "ë±ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤" : `ë‚¨ì€ ì¹´ë“œ: ${deck.length}ì¥`;

                actionBtn.disabled = false;
                if (deck.length === 0) {
                    actionBtn.className = "w-full max-w-xl py-4 rounded-xl text-xl font-bold shadow-lg transition-all transform active:scale-95 mb-8 bg-purple-600 hover:bg-purple-500 text-white shadow-purple-900/50 flex items-center justify-center gap-2";
                    actionBtn.innerHTML = `<i data-lucide="shuffle" class="w-6 h-6"></i> ì…”í”Œ & ë‹¤ìŒ ë¼ìš´ë“œ`;
                } else {
                    actionBtn.className = "w-full max-w-xl py-4 rounded-xl text-xl font-bold shadow-lg transition-all transform active:scale-95 mb-8 bg-slate-700 hover:bg-slate-600 text-white shadow-slate-900/50 flex items-center justify-center gap-2";
                    actionBtn.innerHTML = "ë‹¤ìŒ í„´ ì¹´ë“œ ë½‘ê¸°";
                }
            } else {
                backView.classList.remove('hidden'); shuffleView.classList.add('hidden'); frontView.classList.add('hidden');
                actionBtn.disabled = false;
                actionBtn.className = "w-full max-w-xl py-4 rounded-xl text-xl font-bold shadow-lg transition-all transform active:scale-95 mb-8 bg-slate-700 hover:bg-slate-600 text-white shadow-slate-900/50 flex items-center justify-center gap-2";
                actionBtn.innerHTML = "ë‹¤ìŒ í„´ ì¹´ë“œ ë½‘ê¸°";
            }

            // íˆìŠ¤í† ë¦¬ ë Œë”ë§
            const historyContainer = document.getElementById('history-container');
            historyContainer.innerHTML = '';
            if (roundHistory.length === 0) {
                historyContainer.innerHTML = '<span class="text-slate-600 text-sm py-2 w-full text-center whitespace-nowrap">ì•„ì§ ì§„í–‰ëœ í„´ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
            } else {
                roundHistory.forEach((card, index) => {
                    const el = document.createElement('div');
                    el.className = `flex-shrink-0 w-10 h-14 rounded flex items-center justify-center text-xs font-bold shadow-sm border border-white/20 ${card.colorClass} cursor-pointer hover:brightness-125 hover:border-white/50 transition-all`;
                    el.textContent = card.id;
                    el.title = "í´ë¦­í•˜ì—¬ ë±ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°";
                    el.onclick = (e) => { e.stopPropagation(); openReturnModal(index); };
                    historyContainer.appendChild(el);
                });
            }
            const remaining = Math.max(0, 6 - roundHistory.length);
            for(let i=0; i<remaining; i++) {
                const el = document.createElement('div');
                el.className = 'flex-shrink-0 w-10 h-14 rounded bg-slate-700/30 border-2 border-dashed border-slate-700';
                historyContainer.appendChild(el);
            }

            lucide.createIcons();
        }

        renderLeftSidebar();
        renderRightSidebar();
        initGame();
    </script>
</body>
</html>